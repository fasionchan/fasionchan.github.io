---
layout: page
title: "监控系统(被动)"
date: 2017-03-25 11:30
comments: true
sharing: true
footer: true
---

这是一套全新设计的监控系统，为游戏部所有服务器和线上服务提供**状态监视**、**指标采集**、**异常检测/告警**以及**数据报表**等服务。
系统分**被动监控**以及**[主动监控](/me/projects/monitor-active.html)**两部分，下面介绍的是被动监控部分，侧重于指标数据的收集分析应用。

## 架构

{% img /images/projects/monitor-passive.png 监控系统(被动) %}

### agent

`agent`是一个常驻监控客户端，部署在每台受监控服务器上。
`agent`核心提供一个**插件调度模块**和一个**长连接通讯(控制)模块**，具有以下特点：

- **插件式设计**，提供一个通用插件编写框架，可以**灵活扩展**(采集)功能；
- 插件开发调试框架，可以不依赖实际运行环境开发；
- 插件采用`Python`包部署，支持**动态加载**和**热更新**；
- 插件采用`git`管理代码，提交后自动打包并发布；
- 与控制服务器保存**长连接**，支持心跳保活；
- 跨平台，支持`Linux`、`BSD`、`Windows`以及`OSX`等操作系统；
- `agent`发布新版本后，运行实例**自动升级**；
- 自带`Python`执行环境，不影响宿主；
- 运行稳定，占用资源小；

### CMDB

`CMDB`是整个系统的元数据所在，定义了**机器**-**群组**-**服务**-**端口**-**插件**等配置模型。
通过`CMDB`可以计算出哪些机器需要运行哪些监控插件监控哪些服务。

### Arbiter

`Arbiter`是一个全局仲裁器，负责监视`Publisher`节点的状态，并将机器监控配置进行划分推给健康的`Publisher`节点。
`Arbiter`提供一个接口，供`agent`查询其需要连接哪个`Publisher`节点。

### Publisher

`Publisher`是一个**控制服务器**，为`agent`提供**配置同步**、**命令下发**以及**数据提交**等服务。
`Publisher`以网络域(机房)为单位进行部署，每个域至少部署两个节点，为该域下所有`agent`提供服务。
`Publisher`以长连接连到`Aribter`模块，`Arbiter`监视其状态，并把一个域下所有机器的监控配置(以机器为单位)平均划分下发到可用的`Publisher`上。

在`agent`用长连接与`Publisher`保持活跃通讯，`Publisher`推送其配置信息。
`agent`采集到数据后也通过该长连接进行提交，`Publisher`负责将数据转发到消息队列集群(`MQ`)。
系统支持下发一个命令给某台机器上的`agent`执行，也是通过`Publisher`转发给`agent`的。

{% img /images/projects/monitor-publisher.png %}

上图是`Publisher`节点架构图，绿色部分为`Publisher`服务实例，进程协作关系如下：

`Main`主进程与`Arbiter`保持长连接通讯，接受状态监控，接收`Aribter`推送配置。
主进程启动后创建工作进程`Worker`系列，并监视其运行状态，并将配置划分(IP哈希)推送。
主进程监听服务端口，接受`agent`长连接，对新连接进行身份验证后，将文件描述符发给负责的工作进程(IP哈希)。
`Worker`接到新的文件描述符后(新`agent`连接)，为其提供配置推送，命令下发，数据转发等连接控制服务。

### DB

指标数据(时序数据)采用`MongoDB`做存储。按照数据粒度不同，总共分成4个集群。
每个集群由`5`分片(`shard`)组成，每个分片有`3`个副本集(`replica set`)，总共`15`个`mongod`实例。
规模最大的集群每天支撑超过`20`亿条文档的写入压力，每台数据库实例插入速度超过**`1`万`QPS`**。
